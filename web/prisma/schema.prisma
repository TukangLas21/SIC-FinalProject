generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Room {
  id             String      @id @default(cuid())
  name           String      // e.g., "Microbio Lab A"
  description    String?
  
  bslLevel       BSLLevel    @default(BSL_1)
  targetTemp     Float       @default(24.0) // Celsius
  
  components     Component[]
  sensorLogs     SensorLog[]
  usageLogs      UsageLog[]
  
  // Airflow connections
  airflowsFrom   AirflowConnection[] @relation("SourceRoom")
  airflowsTo     AirflowConnection[] @relation("TargetRoom")
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model Component {
  id          String        @id @default(cuid())
  name        String        // e.g., "Main Exhaust Fan"
  type        ComponentType // EXHAUST, AC, DOOR, etc.
  
  isActive    Boolean       @default(false)
  setting     Float?        // e.g., Fan Speed (PWM %) or AC Temp
  
  roomId      String
  room        Room          @relation(fields: [roomId], references: [id])
  
  powerLogs   PowerLog[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model SensorLog {
  id          Int      @id @default(autoincrement()) // Int is faster for massive logs
  
  roomId      String
  room        Room     @relation(fields: [roomId], references: [id])

  temperature Float    // Celsius
  humidity    Float    // %
  
  anomalyStatus String? // "NORMAL", "LEAK", "CLOG"
  
  createdAt   DateTime @default(now()) // Timestamp
  
  @@index([roomId, createdAt]) // Optimize query speed for graphs
}

model PowerLog {
  id          Int       @id @default(autoincrement())
  
  componentId String
  component   Component @relation(fields: [componentId], references: [id])
  
  voltage     Float     // Volts
  current     Float     // Amps
  power       Float     // Watts (V * I)
  
  createdAt   DateTime  @default(now())
}

model UsageLog {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id])
  
  userName  String   // e.g., "Dr. Strange"
  activity  String   // e.g., "Sample Analysis"
  
  startTime DateTime @default(now())
  endTime   DateTime?
}

model AirflowConnection {
  id          String   @id @default(cuid())
  
  sourceRoomId String
  sourceRoom   Room    @relation("SourceRoom", fields: [sourceRoomId], references: [id], onDelete: Cascade)
  
  targetRoomId String
  targetRoom   Room    @relation("TargetRoom", fields: [targetRoomId], references: [id], onDelete: Cascade)
  
  flowType     FlowType @default(EXHAUST) // INTAKE or EXHAUST
  flowRate     Float?   // CFM (Cubic Feet per Minute) - optional
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Prevent duplicate connections in same direction
  @@unique([sourceRoomId, targetRoomId])
  @@index([sourceRoomId])
  @@index([targetRoomId])
}

enum FlowType {
  INTAKE   // Fresh air coming into the room
  EXHAUST  // Air being exhausted out of the room
  TRANSFER // Room-to-room transfer
}

enum BSLLevel {
  BSL_1
  BSL_2
  BSL_3
  BSL_4
}

enum ComponentType {
  EXHAUST_FAN
  INTAKE_FAN
  AC_UNIT
  DOOR_SENSOR
  LIGHTING
  TEMPERATURE
  HUMIDITY
  AIR_PRESSURE
  AIR_QUALITY
  OTHER
}